const fs = require('fs-extra');
const path = require('path');
const chalk = require('chalk');
class FileService {
constructor(rootDir) {
this.rootDir = rootDir;
this.backupDir = path.join(rootDir, '.ai-bridge', 'backups');
}
validatePath(targetRelativePath) {
const resolvedPath = path.resolve(this.rootDir, targetRelativePath);
if (!resolvedPath.startsWith(this.rootDir)) {
throw new Error(`Security Violation: Attempted to write outside root directory. Path: ${targetRelativePath}`);
}
return resolvedPath;
}
async createBackup(absolutePath) {
if (await fs.pathExists(absolutePath)) {
const relativePath = path.relative(this.rootDir, absolutePath);
const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const backupPath = path.join(
this.backupDir,
timestamp,
relativePath
);
await fs.ensureDir(path.dirname(backupPath));
await fs.copy(absolutePath, backupPath);
return true;
}
return false;
}
async safeWrite(relativePath, content) {
const absolutePath = this.validatePath(relativePath);
await fs.ensureDir(path.dirname(absolutePath));
await this.createBackup(absolutePath);
await fs.writeFile(absolutePath, content, 'utf8');
return {
path: relativePath,
status: 'written',
timestamp: new Date().toISOString()
};
}
}
module.exports = { FileService };